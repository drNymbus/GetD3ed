<!DOCTYPE html>
<meta charset="utf-8">
<title>Trajectories</title>
<link rel="stylesheet" type="text/css" href="css/normalize.css">
<link rel="stylesheet" type="text/css" href="css/style.css">
<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">-->
<body>
  <header>
    <a href="http://www.lirmm.fr/lirmm_eng" target="_blank"><img src="img/lirmm.png" class="logo" /></a>
    <h1>Representative Movement Patterns</h1>
    <a href="http://www.umontpellier.fr/" target="_blank"><img src="img/um.png" class="logo" /></a>
  </header>
  <div id="trajectoire">
  <div id="legende">
    <div class="btnLegende">
    </div>
  </div>
  <script>
  </script>
  <div id="chart">

    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="js/jquery-3.2.1.min.js"></script>
    <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->
    <script src="js/sankey.js"></script>
    <script>
"use strict"
function checkInput(obj){
  var checked = $(obj).prop("checked");
  var classe = obj.getAttribute("class");

  if(!checked){
    var path = $("g path." + classe);
    $(path).addClass("disabled");
    $(path).hide()
  }
  else{
    var path = $("g path." + classe + ".disabled");
    $(path).removeClass("disabled");
    $(path).show();
  }
}

var units = "Widgets";

var margin = {top: 40, right: 40, bottom: 40, left: 40};
var width = 624 - margin.right - margin.left;
var height = 800 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"),    // zero decimal places
format = function(d) { return formatNumber(d) + " " + units; },
color = d3.scale.category20();
//color = d3.rgb("steelblue");

// load the json data
d3.json("json/newjson.json", function(error, graph) {

//Redimensionnement de la taille en fonction du nombre de temps total
  var nbtime;
  for(var i = 0; i < graph.nodes.length; i++){
    nbtime = graph.nodes[i].time
  }
  console.log(nbtime);
  width = width + 100*nbtime;
  console.log(width);
  var svg = d3.select("#chart").append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform", 
  "translate(" + margin.left + "," + margin.top + ")");
  // Set the sankey diagram properties
  var sankey = d3.sankey()
  .nodeWidth(24)
  .nodePadding(10)
  .size([width, height]);
//---------------- Initialisation du svg Terminée ----------------- 
// path est une fonction -> permet la création des liens entre clusters
  var path = sankey.link();
  
  if(graph == null){
    if(error.message == null){
      alert("Il y a une erreur : Fichier non trouvé");
    }
    else{
      alert("Il y a une erreur : " + error.message);
    }
  }
  var nodeMap = {};
  graph.nodes.forEach(function(x) {nodeMap[x.id] = x; });
    //Création des checkbox du côté de la légende  + Ajout des pattern sur les objets link
  $(".btnLegende").append($("<ul>")
    .append($("<li>")
      .append($("<input>")
        .attr("type","button")
        .attr("value","Database")
        .attr("onclick","javascript:location.href='database.html'")))
    /*.append($("<li>")
      .append($("<label>")
        .addClass("database")
        .append($("<input>")
          .addClass("database")
          .attr("type","checkbox")
          .attr("checked","true")
          .on("click",function(evt){
            checkInput(this);
          }))
        .append("Database")))*/);
  //console.log(graph.links);
  graph.links = [];
  if(graph.patterns != null){
    graph.patterns.forEach(function(x){
      var arrayID = [];
      if(x.links.length != 0){
        $(".btnLegende > ul")
        .append($("<li>")
          .addClass(x.name)
          .append($("<label>")
            .addClass(x.name)
            .append($("<input>")
              .addClass(x.name)
              .attr("type","checkbox")
              .attr("checked","true")
              .on("click",function(evt){
                var checked = $(this).prop("checked");
                var checkbox = document.querySelectorAll(".btnLegende ." + this.getAttribute("class") + " li input");
                console.log(checkbox);
                var arr = [];
                arr = Array.prototype.slice.call(checkbox);
                console.log(arr);
                $(checkbox).prop("checked", checked);
                arr.forEach(function(obj){
                    checkInput(obj);
                })
              }))
            .append(x.name))
            .append($("<button>")
              .text("▼")
              .addClass("button " + x.name)
              .attr("type","button")
              .on("click",function(evt){
                if($(".btnLegende ul li." + x.name + " ul").css('display') == 'none'){
                  $(".btnLegende ul li." + x.name + " ul").show();
                  $("." + x.name +" > button").text("▼");
                } else {
                  $(".btnLegende ul li." + x.name + " ul").hide();
                  $("." + x.name +" > button").text("▲");
                }
              })
              ));
        $(".btnLegende ul li." + x.name).append($("<ul>"));
        x.links.forEach(function(y){

          if(!arrayID.includes(y.id)){
            $(".btnLegende ul li." + x.name + " ul")
            .append($("<li>")
              .append($("<label>")
                .addClass(x.name + y.id)
                .append($("<input>")
                  //.addClass(x.name)
                  .addClass(x.name + y.id)
                  .attr("type","checkbox")
                  .attr("checked","true")
                  .on("click",function(evt){
                    //console.log(this);
                    checkInput(this);
                  }))
                .append(y.id + " - N° objects : " + y.value)
                .attr("title", "Objects : " + y.label)));
            arrayID.push(y.id);
          }
          var obj = y;
          obj.patterns = x.name;
          graph.links.push(obj);
        });
      }
    });
  }
  // Création d'évênement sur les checkbox
  $(".btnLegende label").hover(function(){
    var classe = this.getAttribute("class");
    $("#chart svg g path." + classe).addClass("hover");
  },function(){
    var classe = this.getAttribute("class");
    $("#chart svg g path." + classe).removeClass("hover");
  });

  // Créé les liens avec les numéros de node dans graphe.link
  graph.links = graph.links.map(function(x) {
    /*if(x.patterns == null){
      x.patterns = "database";  
    }*/
    return {
      id : x.id,
      source: nodeMap[x.source],
      target: nodeMap[x.target],
      value: x.value,
      label: x.label,
      patterns: x.patterns
    };
  });

  // initialise les éléments graph.nodes et graph.links dans sankey, la fonction layout définis les positionnements etc ...
  sankey
  .nodes(graph.nodes)
  .links(graph.links)
  .layout(32);
  console.log(graph.nodes);
  // add in the links
  var link = svg.append("g").selectAll(".link")
  .data(graph.links)
  .enter().append("path")
  .attr("class", "link")
  .each(function(x){
    if(x.patterns != null){
      var elt = d3.select(this);
      //if(x.patterns != "database"){
        elt.classed(x.patterns + x.id, true);
      //}
      elt.classed(x.patterns, true);
    }
  })

  .attr("d", function(x){return path(x,0);})
  .style("stroke-width", function(d){return 3*d.value;})
  .sort(function(a, b) { return b.dy - a.dy; });
    /*
    .append("path")
    .classed("link",true)
    .each(function(x){
      var elt = d3.select(this);
      elt.classed(x.name,true); 
    }, true)
    .attr("d",function(d,i){console.log(index + " " + i);return path(obj,0.5*(obj.value * d.links.length) * (i+1));})
    .style("stroke-width", function(d){return 0.5*(obj.value * d.links.length);});*/

  // add in the label for the edges on mouse over 
  link.append("title").text(function(d) {
    var str = "Objects : " + d.label;
    return str;
  });

  $("#chart svg g path").hover(function(){
    var classe = this.getAttribute("class");
    $("#chart svg g path[class='"+classe+"']").addClass("hover");
  },function(){
    var classe = this.getAttribute("class");
    $("#chart svg g path[class='"+classe+"']").removeClass("hover");
  });
  /*
  link.data().forEach(function(obj, index){
    var cpt = 0;
    obj.pattern.forEach(function(objPattern,indexPattern){
      svg.append("g").selectAll(".link").data(objPattern.links).enter()
      .append("path")
      .classed("link",true)
      .each(function(x){
        var elt = d3.select(this);
        elt.classed(objPattern.name + x.id, true);
        elt.classed(objPattern.name, true);
      })
      .attr("d",function(d,i){cpt++;return path(obj,0.5 * obj.value * cpt)})
      .style("stroke-width", function(d){return 0.5*obj.value})
    });
  });
  */
  /*
  // Ajout des classes sur les links
  link.data().forEach(function(lien, index){
    if(lien.pattern!=null){
      lien.pattern.forEach(function(pattern){
        $(link[0][index]).addClass(pattern.name);
        pattern.links.forEach(function(patternLink){
          $(link[0][index]).addClass(pattern.name + patternLink.id);
        });
      });
    }
  });
  */  
  // add the link titles
  /*
    link.append("title")
          .text(function(d) {
        	return d.source.name + " → " + 
                  d.target.name + "\n" + format(d.value); });
                  */

  //var lastTime = 0;
  var lastX = -1;
  var timeArray = [];
  (graph.nodes).forEach(function(cluster){
    if(cluster.x != lastX){
      //lastTime = cluster.time;
      lastX = cluster.x;
      timeArray.push(lastX);
      console.log(lastX);
      //timeArray.splice(lastTime - 1, 0, lastX);
    }  
  })
  console.log(timeArray.length);
  for(var i = 0; i < timeArray.length; i++){
    //Affichage des temps
    /*
    var time = [];
    graph.nodes.forEach(function(obj){
    console.log(obj["time"]);
    });*/
    svg.append("line")
      .attr("x1", timeArray[i] + 12)
      .attr("y1", 20 - margin.top)
      .attr("x2", timeArray[i] + 12)
      .attr("y2", height + 200)
      .style("stroke-width", 2)
      .style("stroke", "black")
      .style("fill", "none");

    svg.append("text")
      .attr("y", 15 - margin.top)//magic number here
      .attr("x", timeArray[i] + 12)
      .attr('text-anchor', 'middle')
      .attr("class", "time")//easy to style with CSS
      .text(function(d) {return "T" + (i + 1)}); 
    //Fin Affichage temps

  }

  // add in the nodes
  var node = svg.append("g").selectAll(".node")
  .data(graph.nodes)
  .enter().append("g")
  .attr("class", "node")
  .attr("transform", function(d) {
    return "translate(" + d.x + "," + d.y + ")"; })

  .call(d3.behavior.drag()
    .origin(function(d) { return d; })
    .on("dragstart", function() { 
      this.parentNode.appendChild(this); })
    .on("drag", dragmove));

  // add the rectangles for the nodes
  node.append("rect")
  .attr("height", function(d) {return d.dy; })
  .attr("width", sankey.nodeWidth())
  /*.style("fill", function(d) { 
    return d.color = color(d.id); })*/
  .style("stroke", function(d) { 
    return d3.rgb(d.color).darker(2); })

      /*.append("title")
        .text(function(d) { 
          return d.name + "\n" + format(d.value); });*/

  // add in the label for the nodes
  node.append("text")
  .attr("x", 0)
  .attr("y", function(d) { return d.dy / 2; })
  .attr("dy", ".35em")
  .attr("text-anchor", "begin")
  .attr("transform", null)
  .text(function(d) { return d.id; })

  // add in the label for the nodes on mouse over
  node.append("svg:title")
  .text(function(d) { return d.label; });

  // the function for moving the nodes
  function dragmove(d) {
    d3.select(this).attr("transform", 
      "translate(" + (
       d.x
          	   //d.x = Math.max(0, Math.min(width - d.dx, d3.event.x))
              ) + "," + (
              d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
              ) + ")");
    sankey.relayout();
    link.attr("d", path);
  }

});

</script>
</div>
</div>
</body>
</html>
